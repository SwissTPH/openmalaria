name: Build & Publish OpenMalaria Image

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Base Docker tag (e.g. 48.0)"
        required: true
        default: "48.0"
      push_to_dockerhub:
        description: "Push images to Docker Hub?"
        type: boolean
        required: true
        default: false
      multi_arch:
        description: "Build multi-arch (amd64 + arm64)?"
        type: boolean
        required: true
        default: false

jobs:

  # ===========================
  # AMD64 BUILD (native runner)
  # ===========================
  build_amd64:
    if: ${{ github.event.inputs.multi_arch == 'true' }}
    runs-on: ubuntu-latest  # native AMD64

    steps:
    - uses: actions/checkout@v4

    - name: Docker login (if pushing)
      if: ${{ github.event.inputs.push_to_dockerhub == 'true' }}
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build AMD64 image (native)
      run: |
        docker build \
          -t swisstph/openmalaria:${{ github.event.inputs.tag }}-amd64 \
          -f docker/Dockerfile \
          docker/

    - name: Push AMD64 image
      if: ${{ github.event.inputs.push_to_dockerhub == 'true' }}
      run: docker push swisstph/openmalaria:${{ github.event.inputs.tag }}-amd64


  # ===========================
  # ARM64 BUILD (native runner)
  # ===========================
  build_arm64:
    runs-on: ubuntu-latest-arm64  # native ARM64

    steps:
    - uses: actions/checkout@v4

    - name: Docker login (if pushing)
      if: ${{ github.event.inputs.push_to_dockerhub == 'true' }}
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build ARM64 image (native)
      run: |
        docker build \
          -t swisstph/openmalaria:${{ github.event.inputs.tag }}-arm64 \
          -f docker/Dockerfile \
          docker/

    - name: Push ARM64 image
      if: ${{ github.event.inputs.push_to_dockerhub == 'true' }}
      run: docker push swisstph/openmalaria:${{ github.event.inputs.tag }}-arm64


  # ===========================
  # MULTI-ARCH MANIFEST (only if requested)
  # ===========================
  manifest:
    needs: [build_amd64, build_arm64]
    if: ${{ github.event.inputs.multi_arch == 'true' && github.event.inputs.push_to_dockerhub == 'true' }}
    runs-on: ubuntu-latest

    steps:
    - name: Docker login
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Create and push manifest
      run: |
        docker manifest create swisstph/openmalaria:${{ github.event.inputs.tag }} \
          --amend swisstph/openmalaria:${{ github.event.inputs.tag }}-amd64 \
          --amend swisstph/openmalaria:${{ github.event.inputs.tag }}-arm64

        docker manifest push swisstph/openmalaria:${{ github.event.inputs.tag }}
